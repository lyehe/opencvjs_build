name: Build and Publish OpenCV.js

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      opencv_version:
        description: 'OpenCV version to build'
        required: false
        default: '4.13.0'

env:
  OPENCV_VERSION: ${{ github.event.inputs.opencv_version || '4.13.0' }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download OpenCV sources
        run: |
          git clone --branch ${{ env.OPENCV_VERSION }} --depth 1 https://github.com/opencv/opencv.git
          git clone --branch ${{ env.OPENCV_VERSION }} --depth 1 https://github.com/opencv/opencv_contrib.git

      - name: Build OpenCV.js with Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            -u $(id -u):$(id -g) \
            emscripten/emsdk:latest \
            bash -c "
              mkdir -p /src/dist && \
              python3 /src/opencv/platforms/js/build_js.py /src/build \
                --build_wasm \
                --disable_single_file \
                --simd \
                --threads \
                --cmake_option='-DOPENCV_EXTRA_MODULES_PATH=/src/opencv_contrib/modules' \
                --cmake_option='-DCMAKE_CXX_STANDARD=17' \
                --cmake_option='-DBUILD_DOCS=OFF' \
                --cmake_option='-DBUILD_EXAMPLES=OFF' \
                --cmake_option='-DBUILD_TESTS=OFF' \
                --cmake_option='-DBUILD_PERF_TESTS=OFF' && \
              cp /src/build/bin/opencv.js /src/dist/ && \
              cp /src/build/bin/opencv_js.wasm /src/dist/ && \
              if [ -f /src/build/bin/opencv_js.worker.js ]; then cp /src/build/bin/opencv_js.worker.js /src/dist/; fi && \
              if [ -f /src/build/bin/loader.js ]; then cp /src/build/bin/loader.js /src/dist/; fi
            "

      - name: Get build info
        id: build_info
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          ls -la dist/
          echo "opencv_js_size=$(stat -c%s dist/opencv.js 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "wasm_size=$(stat -c%s dist/opencv_js.wasm 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opencv-wasm-build
          path: |
            dist/opencv.js
            dist/opencv_js.wasm
            dist/opencv_js.worker.js
            dist/loader.js
          if-no-files-found: warn

      # Create/update "latest" pre-release on push to main
      - name: Update Latest Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: "Latest Build (${{ steps.build_info.outputs.date }})"
          prerelease: true
          files: |
            dist/opencv.js
            dist/opencv_js.wasm
            dist/opencv_js.worker.js
            dist/loader.js
          body: |
            ## Latest OpenCV.js Build

            **Auto-updated on every push to main branch.**

            - **Build Date:** ${{ steps.build_info.outputs.date }}
            - **Commit:** ${{ steps.build_info.outputs.sha_short }}
            - **OpenCV Version:** ${{ env.OPENCV_VERSION }}

            ### Download Files

            | File | Description |
            |------|-------------|
            | `opencv.js` | Main JavaScript wrapper |
            | `opencv_js.wasm` | WebAssembly binary |
            | `opencv_js.worker.js` | Web Worker for threading |
            | `loader.js` | Optional loader utility |

            ### Quick Usage

            ```html
            <script async src="opencv.js" onload="onOpenCvReady()"></script>
            <script>
              function onOpenCvReady() {
                console.log('OpenCV.js loaded:', cv.getBuildInformation());
              }
            </script>
            ```

            ### Features
            - All OpenCV contrib modules included
            - SIMD optimization enabled
            - Threading support enabled

            ---
            *For stable releases, use a [versioned release](../../releases) instead.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create versioned release on tag push
      - name: Create Versioned Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/opencv.js
            dist/opencv_js.wasm
            dist/opencv_js.worker.js
            dist/loader.js
          body: |
            ## OpenCV.js ${{ github.ref_name }} with Contrib Modules

            ### Installation

            **npm:**
            ```bash
            npm install opencv-contrib-wasm
            ```

            **Direct download:** Download the files below and include in your project.

            ### Files

            | File | Description | Size |
            |------|-------------|------|
            | `opencv.js` | Main JavaScript wrapper | ~145KB |
            | `opencv_js.wasm` | WebAssembly binary | ~9.7MB |
            | `opencv_js.worker.js` | Web Worker for threading | - |
            | `loader.js` | Optional loader utility | - |

            ### Features
            - OpenCV ${{ env.OPENCV_VERSION }} with all contrib modules
            - SIMD optimization enabled
            - Threading support enabled (requires COOP/COEP headers)

            ### Browser Usage

            ```html
            <script async src="opencv.js" onload="onOpenCvReady()"></script>
            <script>
              function onOpenCvReady() {
                console.log('OpenCV.js ready!');
                // Your code here
              }
            </script>
            ```

            ### Node.js Usage

            ```javascript
            const cv = require('opencv-contrib-wasm');

            cv.onRuntimeInitialized = () => {
              console.log('OpenCV.js ready!');
              // Your code here
            };
            ```

            ### Threading Requirements

            For multi-threading support in browsers, serve with these headers:
            ```
            Cross-Origin-Opener-Policy: same-origin
            Cross-Origin-Embedder-Policy: require-corp
            ```

            ### Included Modules

            **Core:** core, imgproc, imgcodecs, calib3d, features2d, flann, dnn, ml, objdetect, photo, video

            **Contrib:** aruco, bgsegm, face, img_hash, tracking, xfeatures2d, ximgproc, xobjdetect, xphoto, and more

            ---
            [Full documentation](../../#readme) | [Examples](../../tree/main/examples)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: opencv-wasm-build
          path: dist/

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
