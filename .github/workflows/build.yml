name: Build and Publish OpenCV.js

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      opencv_version:
        description: 'OpenCV version to build'
        required: false
        default: '4.13.0'

env:
  OPENCV_VERSION: ${{ github.event.inputs.opencv_version || '4.13.0' }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [essential, full]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download OpenCV sources
        run: |
          git clone --branch ${{ env.OPENCV_VERSION }} --depth 1 https://github.com/opencv/opencv.git
          git clone --branch ${{ env.OPENCV_VERSION }} --depth 1 https://github.com/opencv/opencv_contrib.git

      - name: Build OpenCV.js (${{ matrix.build_type }})
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            -u $(id -u):$(id -g) \
            -e BUILD_TYPE=${{ matrix.build_type }} \
            emscripten/emsdk:latest \
            bash /src/scripts/build.sh

      - name: Get build info
        id: build_info
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          ls -la dist/${{ matrix.build_type }}/
          echo "opencv_js_size=$(stat -c%s dist/${{ matrix.build_type }}/opencv.js 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          echo "wasm_size=$(stat -c%s dist/${{ matrix.build_type }}/opencv_js.wasm 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT
          # Human readable sizes
          echo "wasm_size_mb=$(du -h dist/${{ matrix.build_type }}/opencv_js.wasm | cut -f1)" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opencv-${{ matrix.build_type }}
          path: |
            dist/${{ matrix.build_type }}/opencv.js
            dist/${{ matrix.build_type }}/opencv_js.wasm
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download essential artifacts
        uses: actions/download-artifact@v4
        with:
          name: opencv-essential
          path: dist/essential/

      - name: Download full artifacts
        uses: actions/download-artifact@v4
        with:
          name: opencv-full
          path: dist/full/

      - name: Prepare release assets
        run: |
          # Rename files to avoid name collisions
          mv dist/essential/opencv.js dist/essential/opencv-essential.js
          mv dist/essential/opencv_js.wasm dist/essential/opencv_js-essential.wasm
          mv dist/full/opencv.js dist/full/opencv-full.js
          mv dist/full/opencv_js.wasm dist/full/opencv_js-full.wasm
          ls -la dist/essential/
          ls -la dist/full/

      - name: Get release info
        id: release_info
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "essential_wasm_size=$(du -h dist/essential/opencv_js-essential.wasm | cut -f1)" >> $GITHUB_OUTPUT
          echo "full_wasm_size=$(du -h dist/full/opencv_js-full.wasm | cut -f1)" >> $GITHUB_OUTPUT

      # Create/update "latest" pre-release on push to main
      - name: Update Latest Release
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: "Latest Build (${{ steps.release_info.outputs.date }})"
          prerelease: true
          files: |
            dist/essential/opencv-essential.js
            dist/essential/opencv_js-essential.wasm
            dist/full/opencv-full.js
            dist/full/opencv_js-full.wasm
          body: |
            ## Latest OpenCV.js Build

            **Auto-updated on every push to main branch.**

            - **Build Date:** ${{ steps.release_info.outputs.date }}
            - **Commit:** ${{ steps.release_info.outputs.sha_short }}
            - **OpenCV Version:** ${{ env.OPENCV_VERSION }}

            ### Available Builds

            | Build | WASM Size | Use Case |
            |-------|-----------|----------|
            | **Essential** | ${{ steps.release_info.outputs.essential_wasm_size }} | Core image processing, fast loading |
            | **Full** | ${{ steps.release_info.outputs.full_wasm_size }} | All features including DNN, contrib, threading |

            ### Download Files

            **Essential Build** (faster loading, smaller size):
            | File | Description |
            |------|-------------|
            | `opencv-essential.js` | JavaScript wrapper |
            | `opencv_js-essential.wasm` | WebAssembly binary |

            **Full Build** (all features):
            | File | Description |
            |------|-------------|
            | `opencv-full.js` | JavaScript wrapper |
            | `opencv_js-full.wasm` | WebAssembly binary |

            ### Quick Usage

            ```javascript
            // Essential build (smaller, faster)
            import cv from 'opencv-contrib-wasm/essential';

            // Full build (all features)
            import cv from 'opencv-contrib-wasm/full';
            ```

            ---
            *For stable releases, use a [versioned release](../../releases) instead.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create versioned release on tag push
      - name: Create Versioned Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/essential/opencv-essential.js
            dist/essential/opencv_js-essential.wasm
            dist/full/opencv-full.js
            dist/full/opencv_js-full.wasm
          body: |
            ## OpenCV.js ${{ github.ref_name }} with Contrib Modules

            ### Dual Build System

            This release includes two builds optimized for different use cases:

            | Build | WASM Size | Features | Use Case |
            |-------|-----------|----------|----------|
            | **Essential** | ~3MB | Core, imgproc, features2d | Web apps needing fast load times |
            | **Full** | ~12MB | All modules + contrib + DNN | Full CV applications, research |

            ### Installation

            ```bash
            npm install opencv-contrib-wasm
            ```

            ### Usage

            ```javascript
            // Essential build - smaller, faster loading
            import cv from 'opencv-contrib-wasm/essential';

            // Full build - all features including DNN, contrib
            import cv from 'opencv-contrib-wasm/full';

            // Default export (full build)
            import cv from 'opencv-contrib-wasm';
            ```

            ### Browser Usage

            ```html
            <!-- Essential build -->
            <script src="node_modules/opencv-contrib-wasm/dist/essential/opencv.js"></script>

            <!-- Full build (with threading support) -->
            <script src="node_modules/opencv-contrib-wasm/dist/full/opencv.js"></script>
            ```

            ### Feature Comparison

            | Feature | Essential | Full |
            |---------|:---------:|:----:|
            | Blur, threshold, morphology | ✅ | ✅ |
            | Edge detection (Canny, Sobel) | ✅ | ✅ |
            | ORB, AKAZE, BRISK | ✅ | ✅ |
            | SIFT (xfeatures2d) | ❌ | ✅ |
            | DNN inference | ❌ | ✅ |
            | fastNlMeansDenoising | ❌ | ✅ |
            | Haar cascades | ❌ | ✅ |
            | ArUco markers | ❌ | ✅ |
            | Threading (Web Workers) | ❌ | ✅ |

            ### Threading Requirements (Full Build)

            For multi-threading support in browsers, serve with these headers:
            ```
            Cross-Origin-Opener-Policy: same-origin
            Cross-Origin-Embedder-Policy: require-corp
            ```

            ---
            [Full documentation](../../#readme) | [Examples](../../tree/main/examples)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download essential artifacts
        uses: actions/download-artifact@v4
        with:
          name: opencv-essential
          path: dist/essential/

      - name: Download full artifacts
        uses: actions/download-artifact@v4
        with:
          name: opencv-full
          path: dist/full/

      - name: Verify artifacts
        run: |
          echo "Essential build:"
          ls -la dist/essential/
          echo ""
          echo "Full build:"
          ls -la dist/full/

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
